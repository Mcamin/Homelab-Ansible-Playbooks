---
# ðŸ§© Playbook: inst-docker-ubuntu.yaml
# ðŸ“˜ Description:
# Installs the latest stable Docker Engine, CLI, and related components on Ubuntu-based systems.
# The playbook automatically detects existing Docker repository configurations:
# - If a valid repository already exists, it reuses it.
# - If no repository is found, it adds the official Docker repository using the modern GPG keyring format.
#
# ðŸ”§ Notes:
# - Works on Ubuntu 20.04 (Focal), 22.04 (Jammy), and 24.04 (Noble).
# - Supports both legacy (`.asc`) and new (`.gpg`) repository keyring formats.
# - Ensures all required dependencies and Docker packages are installed.
# - Requires root/sudo privileges.
#
# âš™ï¸ Requirements:
# - Internet access from the target host.
# - Supported Ubuntu release with valid `lsb_release -cs` codename.
#
# ðŸ§  Example usage:
# ansible-playbook -i inventory.ini ./docker/inst-docker-ubuntu.yaml -e "target_group=DockerServers"
#
# ðŸ§© Next steps:
# - Run `docker_certs.yml` to generate Docker TLS certificates for secure connections.
# - Optionally enable TLS via `docker_certs_enable.yml` for remote Docker API access.
#
# âœ… Installed Components:
# | Package | Description |
# |----------|-------------|
# | `docker-ce` | Docker Engine (core service) |
# | `docker-buildx-plugin` | Docker BuildKit plugin for advanced builds |
# | `docker-compose-plugin` | Compose v2 plugin integrated into Docker CLI |

- name: Install Docker (auto-detect repo)
  hosts: "{{ target_group | d([]) }}"
  become: true

  tasks:
    - name: Install Docker dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common
        update_cache: true

    - name: Check if an existing Docker repository is configured
      ansible.builtin.shell: |
        grep -rh "^deb .*download.docker.com" /etc/apt/sources.list.d /etc/apt/sources.list || true
      register: docker_repo_check
      changed_when: false

    - name: Show existing Docker repo (if found)
      ansible.builtin.debug:
        msg: "Existing Docker repository found: {{ docker_repo_check.stdout_lines }}"
      when: docker_repo_check.stdout | length > 0

    - name: Ensure Docker keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      when: docker_repo_check.stdout | length == 0

    - name: Add Docker GPG key (only if no existing repo)
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.gpg
        mode: '0644'
      when: docker_repo_check.stdout | length == 0

    - name: Add Docker repository (only if no existing repo)
      ansible.builtin.apt_repository:
        filename: docker
        repo: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu
          {{ ansible_lsb.codename | lower }} stable
        state: present
      when: docker_repo_check.stdout | length == 0

    - name: Update package index
      ansible.builtin.apt:
        update_cache: true

    - name: Install Docker Engine and plugins
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present

    - name: Ensure Docker service is enabled and running
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true
