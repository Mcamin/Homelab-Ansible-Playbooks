---
# ðŸ§© Playbook: inst-docker-ubuntu.yaml
# ðŸ“˜ Description:
# Installs the latest stable Docker Engine, CLI, and related components on Ubuntu-based systems.
# The playbook adds Dockerâ€™s official GPG key and repository cleanly (removing any conflicting entries),
# installs required dependencies, and ensures all Docker packages (including Buildx and Compose plugins)
# are installed and up to date.
#
# ðŸ”§ Notes:
# - Designed for Debian/Ubuntu systems using `apt`.
# - Compatible with Ubuntu 20.04 (Focal), 22.04 (Jammy), and 24.04 (Noble).
# - Automatically removes old repository definitions to prevent "Conflicting values set for option Signed-By" errors.
# - Uses the modern keyring path `/etc/apt/keyrings/docker.gpg` per Dockerâ€™s 2024 installation guidelines.
# - Requires root/sudo privileges.
#
# âš™ï¸ Requirements:
# - Internet access from the target host.
# - Supported Ubuntu release with valid `lsb_release -cs` codename.
#
# ðŸ§  Example usage:
# ansible-playbook -i inventory.ini ./docker/inst-docker-ubuntu.yaml -e "target_group=DockerServers"
#
# ðŸ§© Next steps:
# - Run `docker_certs.yml` to generate Docker TLS certificates for secure connections.
# - Optionally enable TLS via `docker_certs_enable.yml` for remote Docker API access.
#
# âœ… Installed Components:
# | Package | Description |
# |----------|-------------|
# | `docker-ce` | Docker Engine (core service) |
# | `docker-buildx-plugin` | Docker BuildKit plugin for advanced builds |
# | `docker-compose-plugin` | Compose v2 plugin integrated into Docker CLI |

- name: Install Docker
  hosts: "{{ target_group | d('all') }}"
  become: true

  tasks:
    - name: Install Docker dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common
        update_cache: true

    - name: Remove conflicting old Docker repository files (if present)
      ansible.builtin.file:
        path: /etc/apt/sources.list.d/docker.list
        state: absent

    - name: Ensure Docker keyrings directory exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.gpg
        mode: '0644'

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        filename: docker
        repo: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu
          {{ ansible_lsb.codename | lower }} stable
        state: present

    - name: Update package index
      ansible.builtin.apt:
        update_cache: true

    - name: Install Docker Engine and plugins
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: false

    - name: Ensure Docker service is enabled and running
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true
