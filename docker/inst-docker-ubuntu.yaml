---
# ðŸ§© Playbook: inst-docker-ubuntu.yaml
# ðŸ“˜ Description:
# Installs the latest stable Docker Engine, CLI, and related components on Ubuntu-based systems.
# The playbook adds Dockerâ€™s official GPG key and repository, installs required dependencies,
# and ensures all necessary Docker packages (including Buildx and Compose plugins) are present.
#
# ðŸ”§ Notes:
# - Designed for Debian/Ubuntu systems using `apt`.
# - Adds Dockerâ€™s official repository from `https://download.docker.com/linux/ubuntu`.
# - Installs `docker-ce`, `docker-buildx-plugin`, and `docker-compose-plugin`.
# - Requires root/sudo privileges.
# - Compatible with modern Ubuntu releases (20.04, 22.04, 24.04).
# - The default architecture is `amd64` â€” modify the repository definition if using ARM or other architectures.
#
# âš™ï¸ Requirements:
# - Internet access from the target machine.
# - Supported Ubuntu release (e.g., Jammy, Noble, Focal).
#
# ðŸ§  Example usage:
# ansible-playbook -i inventory.ini ./docker/inst-docker-ubuntu.yaml -e "target_group=DockerServers"
#
# ðŸ§© Next steps:
# - Run `docker_certs.yml` to generate Docker TLS certificates for secure connections.
# - Optionally enable TLS via `docker_certs_enable.yml` for remote Docker API access.
#
# âœ… Installed Components:
# | Package | Description |
# |----------|-------------|
# | `docker-ce` | Docker Engine (core service) |
# | `docker-buildx-plugin` | Docker BuildKit plugin for advanced builds |
# | `docker-compose-plugin` | Compose v2 plugin integrated into Docker CLI |

- name: Install Docker
  hosts: "{{ target_group | d('all') }}"
  become: true

  tasks:
    - name: Install Docker dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg-agent
          - software-properties-common
        update_cache: true

    - name: Add Docker GPG key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
        keyring: /etc/apt/keyrings/docker.gpg

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        filename: docker
        repo: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg]
          https://download.docker.com/linux/ubuntu
          {{ ansible_lsb.codename | lower }} stable
        state: present

    - name: Install Docker Engine and plugins
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-buildx-plugin
          - docker-compose-plugin
        update_cache: true
