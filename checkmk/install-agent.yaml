---
# ğŸ§© Playbook: install_checkmk_agent.yml
# ğŸ“˜ Description:
# Installs and registers the Checkmk Agent on all selected hosts using the official
# `checkmk.general.agent` role. This enables host monitoring and automatic registration
# with your Checkmk monitoring server.
#
# ğŸ”§ Notes:
# - Designed for hosts managed under Checkmk monitoring.
# - Supports automatic agent registration and TLS setup.
# - Expects credentials (automation user + secret) to be provided securely
#   via **Semaphore Variable Groups or Secrets** â€” not from a local `vars_files`.
# - Works with both HTTP and HTTPS Checkmk server protocols.
# - Automatically activates the host after registration if `checkmk_agent_auto_activate` is true.
#
# âš™ï¸ Requirements:
# - The `checkmk.general` Ansible collection must be installed:
#   â¤ `ansible-galaxy collection install checkmk.general`
# - The Checkmk monitoring server must be reachable from the target hosts.
#
# ğŸ”’ Secrets:
# Store these as **Semaphore secrets or variables** instead of plaintext:
#   - `automation_user`: Checkmk automation account username
#   - `automation_secret`: Corresponding automation secret or password
#
# ğŸ§  Example usage:
# ansible-playbook -i inventory.ini ./monitoring/install_checkmk_agent.yml -e "target_group=Servers"
#
# âœ… Example Variables (in Semaphore or vars section):
# checkmk_agent_version: "2.4.0p14-1"
# checkmk_agent_server: "checkmk.home.arpa"
# checkmk_agent_server_protocol: "https"
# checkmk_agent_site: "cmk"
# checkmk_agent_auto_activate: true
# checkmk_agent_tls: true
# checkmk_agent_user: "{{ automation_user }}"
# checkmk_agent_pass: "{{ automation_secret }}"
# checkmk_agent_host_name: "{{ ansible_hostname }}"


- name: Install and debug Checkmk agent registration
  hosts: "{{ target_group | d('all') }}"
  become: true

  vars:
    checkmk_agent_version: "2.4.0p14"
    checkmk_agent_server: "checkmk.home.arpa" # Change to your checkmk url
    checkmk_agent_server_protocol: "https"
    checkmk_agent_site: "cmk" # Change to your checkmk site id
    checkmk_agent_auto_activate: true
    checkmk_agent_tls: true
    checkmk_agent_user: "{{ automation_user }}" # Configure this variable accordingly
    checkmk_agent_pass: "{{ automation_secret }}" # Configure this variable accordingly
    checkmk_agent_host_name: "{{ ansible_hostname }}" # Do not change

  tasks:
    - name: Run Checkmk agent installation role
      ansible.builtin.include_role:
        name: checkmk.general.agent
      #roles:
      #  - checkmk.general.agent

    - name: Manually register Checkmk agent (debug)
      become: true
      ansible.builtin.shell: |
        cmk-agent-ctl register \
          --hostname {{ ansible_hostname }} \
          --server {{ checkmk_agent_server }} \
          --site {{ checkmk_agent_site }} \
          --user {{ checkmk_agent_user }} \
          --password {{ checkmk_agent_pass }} \
          --trust-cert --debug
      register: reg_result
      ignore_errors: true
      no_log: false
      when: debug_mode | bool

    - name: Print registration result
      ansible.builtin.debug:
        var: reg_result.stderr_lines
      when: debug_mode | bool and reg_result is defined






