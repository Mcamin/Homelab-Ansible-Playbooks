---
# ğŸ§© Playbook: update-opkg.yaml
# ğŸ“˜ Description:
# Updates and upgrades software packages on OpenWrt-based routers using `opkg`.
# The playbook lists upgradable packages, upgrades them, and checks if a reboot
# is required (based on whether `libc` or `kernel` packages were updated).
# It safely reboots the router when needed and waits for it to come back online.
#
# ğŸ”§ Notes:
# - Designed specifically for **OpenWrt routers** using the lightweight `opkg` package manager.
# - Uses the `raw` module because OpenWrt typically does not include Python by default.
# - Automatically detects when a reboot is required and triggers it safely.
# - Waits for SSH (port 22) to become available again after a reboot.
# - Does not gather facts to avoid Python dependency errors.
# - Requires SSH access to the router and `become: yes` privileges.
#
# âš™ï¸ Requirements:
# - Router must allow SSH connections and have `opkg` installed.
# - The control node (Ansible host) must be able to connect to the router via SSH.
#
# ğŸ§  Example usage:
# ansible-playbook -i inventory.ini ./openwrt/update-opkg.yaml
#
# ğŸ§© Example inventory entry:
# [openwrt]
# 192.168.1.1 ansible_user=root ansible_connection=ssh

- name: Update and check OpenWrt router safely
  hosts: openwrt
  gather_facts: no
  become: yes

  tasks:
    - name: Update package lists
      ansible.builtin.raw: opkg update
      register: update_result

    - name: Get list of upgradable packages
      ansible.builtin.raw: opkg list-upgradable | cut -d ' ' -f1
      register: upgradable

    - name: Show upgradable packages
      ansible.builtin.debug:
        msg: "{{ upgradable.stdout_lines | default(['No packages need upgrading.']) }}"

    - name: Upgrade all upgradable packages (if any)
      ansible.builtin.raw: opkg upgrade {{ upgradable.stdout_lines | join(' ') }}
      when: upgradable.stdout is defined and upgradable.stdout != ""
      register: upgrade_result

    - name: Check if a reboot is likely needed (kernel/libc updated)
      ansible.builtin.set_fact:
        reboot_needed: "{{ 'libc' in upgradable.stdout or 'kernel' in upgradable.stdout }}"
      when: upgradable.stdout is defined

    - name: Reboot router if needed
      ansible.builtin.raw: sleep 3 && reboot
      when: reboot_needed | default(false)
      async: 0
      poll: 0

    - name: Wait for router to come back
      ansible.builtin.wait_for:
        host: "{{ inventory_hostname }}"
        port: 22
        delay: 20
        timeout: 300
      when: reboot_needed | default(false)
