---
# ðŸ§© Playbook: maint-diskspace.yaml
# ðŸ“˜ Description:
# Checks disk space usage on target hosts and sends a Telegram alert if usage exceeds 80%.
# The playbook runs safely without gathering system facts and supports notification
# integration via Telegram using bot credentials stored as environment variables.
#
# ðŸ”§ Notes:
# - Works on all Linux hosts that provide `df` and `awk`.
# - Requires environment variables or Semaphore secrets:
#     TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID
# - The Telegram bot can be created using @BotFather on Telegram.
# - Update threshold (currently 80%) in the condition if needed.
# - The commented-out Discord section shows how to integrate Discord instead.
#
# ðŸ§  Example usage:
# ansible-playbook -i inventory.ini ./common/maint-diskspace.yaml -e "target_group=UbuntuServers"

- name: Check disk space
  hosts: "{{ target_group | d('all') }}"
  gather_facts: no

  vars:
    telegram_bot_token: "{{ lookup('env', 'TELEGRAM_BOT_TOKEN') }}"
    telegram_chat_id: "{{ lookup('env', 'TELEGRAM_CHAT_ID') }}"

  tasks:
    - name: Check disk space available
      ansible.builtin.shell:
        cmd: |
          set -euo pipefail
          df -Ph / | awk 'NR==2 {print $5}'
        executable: /bin/bash
      changed_when: false
      register: disk_usage

    - name: Display disk usage
      ansible.builtin.debug:
        msg: "Disk usage on {{ inventory_hostname }}: {{ disk_usage.stdout }}"


    - name: Send Telegram alert if disk usage > 80%
      ansible.builtin.uri:
        url: "https://api.telegram.org/bot{{ telegram_bot_token }}/sendMessage"
        method: POST
        body_format: json
        body:
          chat_id: "{{ telegram_chat_id }}"
          text: "âš ï¸ *Alert:* Disk usage on `{{ inventory_hostname }}` is at {{ disk_usage.stdout }} â€” consider cleaning up space."
          parse_mode: "Markdown"
        status_code: 200
      when: disk_usage.stdout[:-1] | int > 80

    # Alternative notification example using Discord webhook:
    # - name: Send Discord message when disk space is over 80%
    #   uri:
    #     url: "your-webhook"
    #     method: POST
    #     body_format: json
    #     body: '{"content": "Disk space on {{ inventory_hostname }} is above 80%!"}'
    #     headers:
    #       Content-Type: application/json
    #     status_code: 204
    #   when: disk_usage.stdout[:-1]|int > 80
