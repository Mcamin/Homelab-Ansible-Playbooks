---
# ðŸ§© Playbook: config-add-sshkey.yaml

- name: Configure SSH key and passwordless sudo for a specific user
  hosts: "{{ target_group | d([]) }}"
  become: true
  vars:
    ssh_user: "{{ ssh_user | default('ubuntu') }}"
    ssh_key_path: "{{ ssh_key_path | default('~/.ssh/id_rsa.pub') }}"

  tasks:
    - name: Create user if not present
      ansible.builtin.user:
        name: "{{ ssh_user }}"
        state: present
        create_home: true
        shell: /bin/bash

    - name: Create .ssh directory
      ansible.builtin.file:
        path: "/home/{{ ssh_user }}/.ssh"
        state: directory
        owner: "{{ ssh_user }}"
        group: "{{ ssh_user }}"
        mode: "0700"

    - name: Install public key
      ansible.posix.authorized_key:
        user: "{{ ssh_user }}"
        key: "{{ lookup('file', ssh_key_path) }}"
        state: present



    - name: Configure passwordless sudo for the specific user in /etc/sudoers
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "^{{ ssh_user }} "
        line: "{{ ssh_user }} ALL=(ALL) NOPASSWD: ALL"
        validate: '/usr/sbin/visudo -cf %s'

